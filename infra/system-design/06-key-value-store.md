### 키-값 저장소 설계
* 키-값 저장소는 키-값 데이터베이스라고도 불리는 비 관계형 데이터베이스이다.
* 키-값 쌍에서의 값은 문자열일 수도 있고 리스트일 수도 있고 객체일 수도 있다.
* 아마존 다이나모, memcached, Redis와 같은 것들이 있다.

**문제 이해 및 설계 범위 확정**
* 다음 특성을 갖는 키-값 저장소 설계
  * 키-값 쌍의 크기는 10KB 이하이다.
  * 큰 데이터를 저장할 수 있어야 한다.
  * 높은 가용성을 제공해야 한다. 따라서 시스템은 설사 장애가 있더라도 빨리 응답해야 한다.
  * 높은 규모 확장성을 제공해야 한다. 따라서 트래픽 양에 따라 자동적으로 서버 증설/삭제가 이루어져야 한다.
  * 데이터 일관성 수즌은 조정이 가능해야 한다.
  * 응답 지연시간이 짧아야 한다.

**단일 서버 키-값 저장소**
* 한대 서버만 사용하는 키-값 저장소를 설계하는 것은 쉽다.
* 가장 직관적인 방법은 키-값 쌍 전부를 메모리에 해시 테이블로 저장하는 것이다.
* 그러나 이 접근법은 빠른 속도를 보장하긴 하지만 모든 데이터를 메모리 안에 두는 것이 불가능할 수도 있다는 약점을 가지고 있다.
  * 개선책으로는 다음과 같다.
    * 데이터 압축
    * 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크에 저장
* 이렇게 개선하더라도 한 대 서버로는 부족한 때가 곧 찾아온다. 많은 데이터를 저장하려면 분산 키-값 저장소를 만들 필요가 있다.

**분산 키-값 저장소**
* 분산 해시 테이블이라고도 불린다.
* 분산 시스템을 설계할 때는 CAP(Consistency, Availability, Partition Tolerance theorem)를 이해하고 있어야한다.

**CAP**
* 일관성, 가용성, 파티션 감내라는 세가지 요구 사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리다.
* 데이터 일관성: 분산 시스템에 접속하는 모든 클라이언트는 언제나 같은 데이터를 보게 되어야 한다.
* 가용성: 일부 노드에 장애가 발생해도 항상 응답 받을 수 있어야 한다.
* 파티션 감내: 파티션은 두 노드 사이에 통신 장애가 의미한다. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작해야 한다는 뜻이다.
* CAP 정리는 이들 가운데 어떤 두 가지를 충족하려면 나머지 하나는 반드시 희생되어야 한다는 것을 의미한다.
* CP 시스템: 일관성과 파티션 감내를 지원, 가용성을 희생
* AP 시스템: 가용성과 파티션 감내를 지원, 데이터 일관성 희생
* CA 시스템: 일관성과 가용성을 지원, 파티션 감내 희생하지만 통상 네트워크 장애는 피할 수 없는 일이므로 실세계에 CA 시스템은 존재하지 않는다.

**이상적 상태**
* 이상적 환경이라면 네트워크가 파티션되는 상황은 절대로 일어나지 않을 것이다.
* n1, n2, n3의 키-값 저장소가 있다면 n1에 기록된 데이터는 나머지에 모두 복제되어 데이터 일관성과 가용성도 만족된다.

**실세계의 분산 시스템**
* 분산 시스템은 파티션 문제를 피할 수 없다. 그리고 파티션 문제가 발생하면 우리는 일관성과 가용성 사이에서 하나를 선택해야 한다.
* n3에 장애가 발생해 n1, n2와 통신할 수 없는 상황에서 n1, n2에 기록한 데이터는 n3에 전달되지 않고 그 반대도 마찬가지다.
* 가용성 대신 일관성을 선택한다면(CP 시스템) 세 서버 사이에 생길 수 있는 데이터 불일치 문제를 피하기 위해 n1, n2에 대해 쓰기 연산을 중단시켜야 한다.
  * 은행권 시스템은 온라인 뱅킹 시스템이 계좌 최신 정보를 출력하지 못하면 큰 문제이기 때문에 보통 데이터 일관성을 양보하지 않는다.
* 일관성 대신 가용성을 선택한 시스템(AP 시스템)은 설사 낡은 데이터를 반환할 위험이 있더라도 계속 읽기 연산을 허용해야 한다.
  * 아울러 n1, n2는 계속 쓰기 연산을 허용할 것이고, 파티션 문제가 해결된 뒤에 새 데이터를 n3에 전송할 것이다.